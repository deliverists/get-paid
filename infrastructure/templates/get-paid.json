{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "get-paid website",
  "Parameters" : {
    "BranchName" : {
      "Type" : "String",
      "Default" : "testing",
      "AllowedValues" : ["master", "testing"],
      "Description" : "master(prod) or testing branch"
    },
    "SchemaS3Location" : {
      "Type" : "String",
      "Description" : "s3 location of the graphql schema"
    }
  },
  "Conditions" : {
    "ProductionBuild" : {"Fn::Equals" : [{"Ref" : "BranchName"}, "master"]}
  },
  "Resources": {
    "ContentBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "AccessControl": "Private"
      }
    },
    "ContentBucketReadPolicy" : {
      "Type" : "AWS::S3::BucketPolicy",
      "Properties" : {
        "Bucket" : {"Ref" : "ContentBucket"},
        "PolicyDocument": {
          "Id": "Origin-Identity-Get-Access",
          "Statement": [{
            "Action": ["s3:GetObject"],
            "Effect": "Allow",
            "Resource": { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "ContentBucket" } , "/*" ]]},
            "Principal": {
              "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity EYMUL4VP44ACS"
            }
          }]
        }
      }
    },
    "WebsiteDistribution": {
      "Type": "AWS::CloudFront::Distribution",
      "Properties": {
        "DistributionConfig": {
          "Comment": { "Fn::Join" : ["", ["website - ", { "Ref" : "BranchName" } ]]},
          "Enabled": "true",
          "PriceClass": { "Fn::Join" : ["", ["PriceClass_", { "Fn::If": ["ProductionBuild", "200", "100"] } ]]},
          "ViewerCertificate" : {
            "CloudFrontDefaultCertificate" : "true"
          },
          "Logging" : {
            "IncludeCookies" : "false",
            "Bucket" : "nickmeldrum-com-logs.s3.amazonaws.com",
            "Prefix": { "Fn::Join" : ["", ["get-paid-cf-logs-", { "Ref" : "BranchName" }, "/" ]]}
          },
          "DefaultCacheBehavior" : {
            "AllowedMethods" : [ "GET", "HEAD" ],
            "TargetOriginId" : "content-origin",
            "ForwardedValues" : {
              "QueryString" : "false",
              "Cookies" : { "Forward" : "none" }
            },
            "ViewerProtocolPolicy" : "redirect-to-https"
          },
          "CustomErrorResponses": [
            {
              "ErrorCode": 403,
              "ResponsePagePath": "/404",
              "ResponseCode": 404
            },
            {
              "ErrorCode": 404,
              "ResponsePagePath": "/404",
              "ResponseCode": 404
            }
          ],
          "Origins": [
            {
              "DomainName": {"Fn::GetAtt": ["ContentBucket", "DomainName"]},
              "Id" : "content-origin",
              "S3OriginConfig" : {
                "OriginAccessIdentity" : "origin-access-identity/cloudfront/EYMUL4VP44ACS"
              }
            }
          ]
        }
      }
    },
    "DynamoDBRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "get_paid_appsync_dynamo_role",
        "ManagedPolicyArns": [
          {
            "Ref": "AppSyncDynamoDBPolicy"
          }
        ],
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "sts:AssumeRole"
                  ],
                  "Principal": {
                    "Service": [
                      "appsync.amazonaws.com"
                    ]
                  }
            }
          ]
        }
      },
      "DependsOn": [
        "AppSyncDynamoDBPolicy"
        ]
    },
    "AppSyncDynamoDBPolicy": {
      "Type": "AWS::IAM::ManagedPolicy",
      "Properties": {
        "Description": "Managed policy to allow AWS AppSync to access the tables created by this template.",
        "Path": "/appsync/",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "dynamodb:GetItem",
                "dynamodb:PutItem",
                "dynamodb:DeleteItem",
                "dynamodb:UpdateItem",
                "dynamodb:Query",
                "dynamodb:Scan",
                "dynamodb:BatchGetItem",
                "dynamodb:BatchWriteItem"
              ],
              "Resource": { "Fn::Join" : ["", [{"Fn::GetAtt": ["InvoicesDynamoTable", "Arn"]}, "*"]]}
            }
          ]
        }
      }
    },
    "InvoicesDynamoTable": {
      "Type": "AWS::DynamoDB::Table",
      "Description": "Data store for Invoices",
      "Properties": {
        "AttributeDefinitions": [
          {
            "AttributeName": "Code",
            "AttributeType": "S"
          },
          {
            "AttributeName": "Date",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "Code",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "Date",
            "KeyType": "RANGE"
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 2,
          "WriteCapacityUnits": 2
        }
      }
    },
    "AppSyncApi": {
      "Type": "AWS::AppSync::GraphQLApi",
      "Properties": {
      "Name": "get_paid_api",
      "AuthenticationType": "API_KEY"
      }
    },
    "AppSyncSchema": {
      "Type": "AWS::AppSync::GraphQLSchema",
      "Properties": {
        "ApiId": {"Fn::GetAtt": ["AppSyncApi", "ApiId"]},
        "DefinitionS3Location": {"Ref" : "SchemaS3Location"}
      }
    },
    "AppSyncInvoicesDataSource": {
      "Type": "AWS::AppSync::DataSource",
      "Properties": {
        "ApiId": {"Fn::GetAtt": ["AppSyncApi", "ApiId"]},
        "Name": "invoices_table",
        "Type": "AMAZON_DYNAMODB",
        "ServiceRoleArn": {"Fn::GetAtt": ["DynamoDBRole", "Arn"]},
        "DynamoDBConfig": {
          "TableName": {"Ref": "InvoicesDynamoTable"},
          "AwsRegion": {"Fn::Sub": "${AWS::Region}"}
        }
      }
    }
  }
}
